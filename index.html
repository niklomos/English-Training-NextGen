<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <title>Login / Register - Vocabulary Trainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #eff6ff, #ecfdf5);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
      }
      .card-login {
        max-width: 420px;
        width: 100%;
        border-radius: 16px;
        box-shadow: 0 10px 35px rgba(15, 23, 42, 0.12);
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
      }

      /* Toast ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
      .status-toast {
        position: fixed;
        left: 50%;
        bottom: 1.5rem;
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
        transition: all 0.25s ease;
        z-index: 1050;
        pointer-events: none;
      }
      .status-toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      .status-toast-inner {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.55rem 1rem;
        border-radius: 999px;
        font-size: 0.85rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.3);
        border: 1px solid rgba(148, 163, 184, 0.5);
        backdrop-filter: blur(10px);
        background: radial-gradient(
            circle at top left,
            rgba(59, 130, 246, 0.18),
            transparent
          ),
          rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
      }
      .status-toast-success .status-toast-inner {
        background: radial-gradient(
            circle at top left,
            rgba(34, 197, 94, 0.22),
            transparent
          ),
          rgba(15, 23, 42, 0.95);
      }
      .status-toast-error .status-toast-inner {
        background: radial-gradient(
            circle at top left,
            rgba(239, 68, 68, 0.22),
            transparent
          ),
          rgba(15, 23, 42, 0.95);
      }
      .status-toast-icon {
        font-size: 1rem;
      }

      /* ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏•‡πâ‡∏≥ ‡πÜ ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ hover */
      #primaryBtn {
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }
      #primaryBtn:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.28);
      }
      #primaryBtn:disabled {
        opacity: 0.85;
      }
    </style>
  </head>

  <body>
    <div class="card card-login p-4">
      <h4 class="mb-1 text-center">Vocabulary Trainer</h4>
      <p class="text-muted small text-center mb-3">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
      </p>

      <ul class="nav nav-pills mb-3 justify-content-center" id="modeTabs">
        <li class="nav-item">
          <button
            class="nav-link active"
            type="button"
            data-mode="login"
            onclick="switchMode('login')"
          >
            Login
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            type="button"
            data-mode="register"
            onclick="switchMode('register')"
          >
            Register
          </button>
        </li>
      </ul>

      <div class="mb-3">
        <label class="form-label">Username</label>
        <input
          id="loginUsername"
          class="form-control"
          autocomplete="username"
        />
      </div>

      <div class="mb-3">
        <label class="form-label">Password</label>
        <input
          id="loginPassword"
          type="password"
          class="form-control"
          autocomplete="current-password"
        />
      </div>

      <div class="mb-3" id="displayNameGroup" style="display: none">
        <label class="form-label">Display name (‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á)</label>
        <input
          id="displayName"
          class="form-control"
          placeholder="‡πÄ‡∏ä‡πà‡∏ô Beam, Mint, ‡πÄ‡∏î‡πá‡∏Å‡∏´‡πâ‡∏≠‡∏á 3/2"
        />
      </div>

      <div class="d-grid gap-2">
        <button
          id="primaryBtn"
          class="btn btn-primary d-flex align-items-center justify-content-center gap-2"
          onclick="submitForm()"
        >
          <span id="primaryBtnLabel">Login</span>
          <div
            id="primaryBtnSpinner"
            class="spinner-border spinner-border-sm text-light d-none"
            role="status"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
        </button>
      </div>

      <div
        id="loginError"
        class="text-danger small mt-3"
        style="display: none"
      ></div>
    </div>

    <!-- Toast ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
    <div
      id="statusToast"
      class="status-toast status-toast-success"
      style="display: none"
    >
      <div class="status-toast-inner">
        <span id="statusToastIcon" class="status-toast-icon">‚úÖ</span>
        <span id="statusToastText">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
      </div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbxF2M9zo8CGTEeHpmNJJtm0yAdg2VzDdQvpqqNBD0pNgS51NjseavEdsfieXt5tyu0bzg/exec";

      let currentMode = "login"; // 'login' | 'register'

      function switchMode(mode) {
        currentMode = mode;

        document
          .querySelectorAll("#modeTabs .nav-link")
          .forEach((btn) =>
            btn.classList.toggle(
              "active",
              btn.getAttribute("data-mode") === mode
            )
          );

        const dnGroup = document.getElementById("displayNameGroup");
        const primaryBtnLabel = document.getElementById("primaryBtnLabel");
        const errorBox = document.getElementById("loginError");
        errorBox.style.display = "none";
        errorBox.textContent = "";

        if (mode === "register") {
          dnGroup.style.display = "block";
          primaryBtnLabel.textContent = "Register";
        } else {
          dnGroup.style.display = "none";
          primaryBtnLabel.textContent = "Login";
        }
      }

      // ‡∏•‡πâ‡∏≤‡∏á prefix "Error: " ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Apps Script ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
      function cleanErrorMessage(msg) {
        if (!msg) return "";
        return String(msg).replace(/^Error:\s*/i, "");
      }

      function showError(msg) {
        const el = document.getElementById("loginError");
        const cleaned = cleanErrorMessage(msg);
        el.textContent = cleaned;
        el.style.display = "block";
        showToast(cleaned, "error");
      }

      // Toast helper
      function showToast(message, type = "success") {
        const toast = document.getElementById("statusToast");
        const icon = document.getElementById("statusToastIcon");
        const text = document.getElementById("statusToastText");

        if (!toast || !icon || !text) return;

        text.textContent = message;
        icon.textContent = type === "success" ? "‚úÖ" : "‚ö†Ô∏è";

        toast.classList.remove("status-toast-success", "status-toast-error");
        toast.classList.add(
          type === "success" ? "status-toast-success" : "status-toast-error"
        );

        toast.style.display = "block";

        // trigger animation (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ browser ‡∏ß‡∏≤‡∏î 1 frame ‡∏Å‡πà‡∏≠‡∏ô)
        requestAnimationFrame(() => {
          toast.classList.add("show");
        });

        // auto hide
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            toast.style.display = "none";
          }, 250);
        }, 2500);
      }

      // Loading state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° + form
      function setLoading(isLoading) {
        const btn = document.getElementById("primaryBtn");
        const label = document.getElementById("primaryBtnLabel");
        const spinner = document.getElementById("primaryBtnSpinner");
        const inputs = document.querySelectorAll("input");

        if (!btn || !label || !spinner) return;

        if (isLoading) {
          btn.disabled = true;
          inputs.forEach((i) => (i.disabled = true));

          label.textContent =
            currentMode === "login"
              ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..."
              : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...";
          spinner.classList.remove("d-none");
        } else {
          btn.disabled = false;
          inputs.forEach((i) => (i.disabled = false));

          label.textContent = currentMode === "login" ? "Login" : "Register";
          spinner.classList.add("d-none");
        }
      }

      async function submitForm() {
        const username = document
          .getElementById("loginUsername")
          .value.trim();
        const password = document
          .getElementById("loginPassword")
          .value.trim();
        const displayName = document
          .getElementById("displayName")
          .value.trim();

        if (!username || !password) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞ password");
          return;
        }

        if (currentMode === "register" && !displayName) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Display name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£");
          return;
        }

        setLoading(true);

        try {
          const payload =
            currentMode === "login"
              ? {
                  action: "login",
                  username,
                  password,
                }
              : {
                  action: "register",
                  username,
                  password,
                  displayName,
                };

          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            showError("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (" + res.status + ")");
            return;
          }

          const json = await res.json();
          if (!json.success) {
            // error ‡∏à‡∏≤‡∏Å backend ‡πÄ‡∏ä‡πà‡∏ô
            // "username ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß" ‡∏´‡∏£‡∏∑‡∏≠ "Display name ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß"
            showError(json.error || "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            return;
          }

          // ----- success -----
          if (currentMode === "login") {
            // login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            localStorage.setItem("vt_user", JSON.stringify(json.user));
            showToast(
              "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Vocabulary‚Ä¶",
              "success"
            );

            // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô toast ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
            setTimeout(() => {
              window.location.href = "app.html";
            }, 600);
          } else {
            // register ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showToast(
              "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß üéâ",
              "success"
            );

            // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î login ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            switchMode("login");
            // ‡∏Ñ‡∏á username ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ / ‡∏•‡πâ‡∏≤‡∏á password + displayName
            document.getElementById("loginPassword").value = "";
            document.getElementById("displayName").value = "";
          }
        } catch (err) {
          console.error(err);
          showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        } finally {
          setLoading(false);
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitForm();
        }
      });

      // ‡∏ñ‡πâ‡∏≤ login ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ app ‡πÄ‡∏•‡∏¢
      (function () {
        try {
          const u = JSON.parse(localStorage.getItem("vt_user") || "null");
          if (u && u.id) {
            window.location.href = "app.html";
          }
        } catch (e) {}
      })();
    </script>
  </body>
</html>
