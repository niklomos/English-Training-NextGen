<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <title>Login / Register - Vocabulary Trainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #eff6ff, #ecfdf5);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
      }
      .card-login {
        max-width: 420px;
        width: 100%;
        border-radius: 16px;
        box-shadow: 0 10px 35px rgba(15, 23, 42, 0.12);
      }
    </style>
  </head>

  <body>
    <div class="card card-login p-4">
      <h4 class="mb-1 text-center">Vocabulary Trainer</h4>
      <p class="text-muted small text-center mb-3">
        เข้าสู่ระบบหรือสมัครสมาชิกใหม่
      </p>

      <ul class="nav nav-pills mb-3 justify-content-center" id="modeTabs">
        <li class="nav-item">
          <button
            class="nav-link active"
            type="button"
            data-mode="login"
            onclick="switchMode('login')"
          >
            Login
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            type="button"
            data-mode="register"
            onclick="switchMode('register')"
          >
            Register
          </button>
        </li>
      </ul>

      <div class="mb-3">
        <label class="form-label">Username</label>
        <input
          id="loginUsername"
          class="form-control"
          autocomplete="username"
        />
      </div>

      <div class="mb-3">
        <label class="form-label">Password</label>
        <input
          id="loginPassword"
          type="password"
          class="form-control"
          autocomplete="current-password"
        />
      </div>

      <div class="mb-3" id="displayNameGroup" style="display: none">
        <label class="form-label">Display name (ชื่อที่ใช้แสดง)</label>
        <input
          id="displayName"
          class="form-control"
          placeholder="เช่น Beam, Mint, เด็กห้อง 3/2"
        />
      </div>

      <div class="d-grid gap-2">
        <button id="primaryBtn" class="btn btn-primary" onclick="submitForm()">
          Login
        </button>
      </div>

      <div
        id="loginError"
        class="text-danger small mt-3"
        style="display: none"
      ></div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbxDQj4g7KH82V-2N9YyoVEWIwyIEAv8wr-DkiCOvL5mxvP9B1C-ifSKkohRVZcF_hqjug/exec";

      let currentMode = "login"; // 'login' | 'register'

      function switchMode(mode) {
        currentMode = mode;

        document
          .querySelectorAll("#modeTabs .nav-link")
          .forEach((btn) =>
            btn.classList.toggle(
              "active",
              btn.getAttribute("data-mode") === mode
            )
          );

        const dnGroup = document.getElementById("displayNameGroup");
        const primaryBtn = document.getElementById("primaryBtn");
        const errorBox = document.getElementById("loginError");
        errorBox.style.display = "none";

        if (mode === "register") {
          dnGroup.style.display = "block";
          primaryBtn.textContent = "Register";
        } else {
          dnGroup.style.display = "none";
          primaryBtn.textContent = "Login";
        }
      }

      function showError(msg) {
        const el = document.getElementById("loginError");
        el.textContent = msg;
        el.style.display = "block";
      }

      async function submitForm() {
        const username = document
          .getElementById("loginUsername")
          .value.trim();
        const password = document
          .getElementById("loginPassword")
          .value.trim();
        const displayName = document
          .getElementById("displayName")
          .value.trim();

        if (!username || !password) {
          showError("กรุณากรอก username และ password");
          return;
        }

        if (currentMode === "register" && !displayName) {
          showError("กรุณากรอก Display name สำหรับการสมัคร");
          return;
        }

        try {
          const payload =
            currentMode === "login"
              ? {
                  action: "login",
                  username,
                  password,
                }
              : {
                  action: "register",
                  username,
                  password,
                  displayName,
                };

          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            showError("เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ (" + res.status + ")");
            return;
          }

          const json = await res.json();
          if (!json.success) {
            showError(json.error || "ดำเนินการไม่สำเร็จ");
            return;
          }

          localStorage.setItem("vt_user", JSON.stringify(json.user));
          window.location.href = "app.html";
        } catch (err) {
          console.error(err);
          showError("เกิดข้อผิดพลาด ลองใหม่อีกครั้ง");
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitForm();
        }
      });

      // ถ้า login อยู่แล้ว เด้งไป index
      (function () {
        try {
          const u = JSON.parse(localStorage.getItem("vt_user") || "null");
          if (u && u.id) {
            window.location.href = "app.html";
          }
        } catch (e) {}
      })();
    </script>
  </body>
</html>
